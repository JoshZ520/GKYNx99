<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <title>Table Talk</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">
    <link rel="stylesheet" href="stylesheets/shared.css">
    <link rel="stylesheet" href="stylesheets/game.css">
    <link rel="stylesheet" href="stylesheets/options.css">
    <link rel="stylesheet" href="stylesheets/images.css">
    <link rel="stylesheet" href="stylesheets/remote.css">
    <script src="scripts/theme-utilities.js" defer></script>
    <script src="scripts/session-utilities.js" defer></script>
    <script src="scripts/game.js" defer></script>
</head>
<body class="game-page" id="root">
    <header id="header">
        <div class="direction">
            <h1>Directions: </h1>            
        </div>
        <div class="header-controls">
            <button class="header-save-btn smooth-transition" id="saveGameBtn" type="button" title="Save Game Progress">
                <img src="images/icons/save.svg" alt="Save" width="18" height="18">
                <span class="save-text">Save</span>
            </button>
            <button id="open_page" type="button"><img src="images/icons/chevron-down.svg" alt="open page"></button>
        </div>
        <div id="directions">
            <p>Choose a topic from the dropdown or use Random to get started. Click the circular switch button to get a new question. When it's your turn, select your preferred option and click Submit. After everyone has answered, click 'All Answers Finished' to see everyone's choices and discuss the results!</p>
            <div class="game-navigation">
                <button class="back-to-mode-btn smooth-transition" id="backToModeBtn" type="button" onclick="window.location.href='index.html'">
                    <img src="images/icons/previous.svg" alt="Back" width="16" height="16">
                    Back to Game Mode
                </button>
                <p class="setup-link"><strong>Need to change players?</strong> <a href="index.html">← Back to Setup</a></p>
            </div>
            
            <!-- Offline Mode Notice -->
            <div id="offlineModeNotice" class="offline-notice hidden" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px;">
                <p><strong>Offline Mode:</strong> Pass this device between players for their turns. Everyone takes turns on the same screen.</p>
            </div>
        </div>

        <!-- Multiplayer Room Info (hidden until room is created) -->
        <div id="multiplayerInfo" class="multiplayer-info hidden">
            <div class="room-display">
                <div class="room-code-section">
                    <span class="room-label">Room Code:</span>
                    <span class="room-code" id="roomCodeDisplay">----</span>
                    <button class="copy-code-btn" id="copyCodeBtn" title="Copy room code">Copy</button>
                </div>
                <div class="players-section">
                    <span class="players-label">Connected Players (<span id="playerCount">0</span>):</span>
                    <div class="players-list" id="connectedPlayersList"></div>
                </div>
            </div>
            <div class="multiplayer-actions">
                <button class="create-room-btn" id="createRoomBtn">Create Room for Phones</button>
                <button class="close-room-btn hidden" id="closeRoomBtn">Close Room</button>
            </div>
        </div>
    </header>
    <main>
        <!-- Player turn indicator -->
        <div id="playerTurnIndicator" class="player-turn-indicator smooth-transition hidden">
            <span class="turn-text smooth-transition">Current Player:</span>
            <span class="current-player-name" id="currentPlayerName"></span>
        </div>
        <h1 class="question" id="question"></h1>
         <div class="topic-selection">
            <button class="smooth-transition" id="topicsToggle">Topics ▼</button>
                <!-- Collapsible topic grid with pagination -->
                <div class="topics-panel hidden" id="topicsPanel">
                    <div class="topics-pagination-header">
                        <span class="page-info" id="pageInfo">Page 1 of 2</span>
                        <div class="pagination-controls">
                            <button class="page-btn smooth-transition" id="prevPageBtn" disabled>‹ Previous</button>
                            <button class="page-btn smooth-transition" id="nextPageBtn">Next ›</button>
                        </div>
                    </div>
                    <div class="topics-grid" id="topicsGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
             <!-- Topic display -->
            <div id="currentTopicDisplay" class="current-topic-display">
                <span class="topic-name" id="currentTopicName">Instructions</span>
            </div>
        <!-- Remote Control Layout -->
        <div class="remote-control">
            <div class="remote-row">
                <!-- Random Topic Button -->
                <div class="remote-button-container">
                    <button class="remote-btn smooth-transition" id="randomTopicBtn" type="button" title="Random Topic">
                        <img src="images/icons/random-dice.svg" alt="Random Topic" width="20" height="20">
                    </button>
                    <span class="remote-label">Random Topic</span>
                </div>
                
                <!-- Previous Question Button -->
                <div class="remote-button-container">
                    <button class="remote-btn smooth-transition" id="prevQuestionBtn" type="button" title="Previous Question">
                        <img src="images/icons/previous.svg" alt="Previous" width="20" height="20">
                    </button>
                    <span class="remote-label">Previous</span>
                </div>
                
                <!-- Random Question Button (Center) -->
                <div class="remote-button-container center">
                    <button class="switch_button smooth-transition flex-center" id="switchQuestion" type="button" title="Random Question in Current Topic">
                        <img id="changeQ" src="images/icons/refresh.svg" alt="Switch Question" width="24" height="24">
                    </button>
                    <span class="remote-label">Random Question</span>
                </div>
                
                <!-- Next Question Button -->
                <div class="remote-button-container">
                    <button class="remote-btn smooth-transition" id="nextQuestionBtn" type="button" title="Next Question">
                        <img src="images/icons/next.svg" alt="Next" width="20" height="20">
                    </button>
                    <span class="remote-label">Next</span>
                </div>
                
                <!-- Skip Question Button -->
                <div class="remote-button-container">
                    <button class="remote-btn smooth-transition" id="skipQuestionBtn" type="button" title="Skip This Question">
                        <img src="images/icons/skip.svg" alt="Skip" width="20" height="20">
                    </button>
                    <span class="remote-label">Skip Question</span>
                </div>
            </div>
        </div>
        <!-- Image-based preference selection -->
        <div class="preference-container" id="preferenceContainer" class="hidden">
            <div class="preference-options">
                <div class="preference-option" id="option1" data-choice="option1">
                    <div class="preference-label" id="option1Label">Option 1</div>
                    <div class="preference-image" id="option1Image">
                        <!-- Image will be loaded here -->
                    </div>
                </div>
                <div class="preference-option" id="option2" data-choice="option2">
                    <div class="preference-label" id="option2Label">Option 2</div>
                    <div class="preference-image" id="option2Image">
                        <!-- Image will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Hidden field to store the selected preference -->
        <input type="hidden" id="selectedPreference" value="">
        <div class="buttons">
            <button class="submit smooth-transition" id="submitButton" type="submit">Submit Answer</button>
            <button class="fin" id="final_submit" type="button">All Answers Finished</button>
        </div>
    </main>



    <footer>
        <h2>About: </h2>
        <p>The purpose of this game is to get to know people.</p>
        <p>Ask Away</p>
    </footer>

    <!-- Conditionally load multiplayer scripts -->
    <script>
        // Check if we're in offline mode before loading multiplayer scripts
        const isOfflineMode = sessionStorage.getItem('offlineMode') === 'true';
        
        if (!isOfflineMode) {
            // Load socket.io and multiplayer manager for online mode
            const socketScript = document.createElement('script');
            socketScript.src = '/socket.io/socket.io.js';
            document.head.appendChild(socketScript);
            
            socketScript.onload = function() {
                const multiplayerScript = document.createElement('script');
                multiplayerScript.src = 'scripts/multiplayer-manager.js';
                multiplayerScript.defer = true;
                document.head.appendChild(multiplayerScript);
            };
            
            socketScript.onerror = function() {
                console.log('Socket.io failed to load - falling back to offline mode');
                sessionStorage.setItem('offlineMode', 'true');
                sessionStorage.setItem('gameMode', 'offline');
                // Trigger offline mode check in game.js
                if (window.checkOfflineMode) {
                    window.checkOfflineMode();
                }
            };
        } else {
            console.log('🔄 Offline mode detected - skipping multiplayer scripts');
            
            // Trigger offline mode UI setup immediately
            document.addEventListener('DOMContentLoaded', function() {
                if (window.checkOfflineMode) {
                    window.checkOfflineMode();
                }
            });
        }
        
        // Load remote control system for both online and offline modes
        const remoteScript = document.createElement('script');
        remoteScript.src = 'scripts/remote.js';
        remoteScript.defer = true;
        document.head.appendChild(remoteScript);
    </script>
</body>
</html>